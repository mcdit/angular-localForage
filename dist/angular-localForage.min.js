/**
 * angular-localforage - Angular service & directive for https://github.com/mozilla/localForage (Offline storage, improved.)
 * @version v1.2.1
 * @link https://github.com/ocombe/angular-localForage
 * @license MIT
 * @author Olivier Combe <olivier.combe@gmail.com>
 */
!function(e,r){"use strict";if("function"==typeof define&&define.amd)define(["localforage"],function(t){r(e.angular,t)});else if("object"==typeof exports){var t=e.angular||window&&window.angular;module.exports=r(t,require("localforage"))}else r(e.angular,e.localforage)}(this,function(e,r){"use strict";var t=e.module("LocalForageModule",["ng"]);t.provider("$localForage",function(){var t={},o={name:"lf"},n={setItem:!1,removeItem:!1},i={},a={"[object ArrayBuffer]":!0,"[object Blob]":!0,"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,"[object Uint16Array]":!0,"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0},f=function(e){return Boolean(a[Object.prototype.toString.call(e)])};this.setNotify=function(e,r){n={setItem:e,removeItem:r}},this.config=function(r){if(!e.isObject(r))throw new Error("The config parameter should be an object");e.extend(o,r)},this.$get=["$rootScope","$q","$parse",function(a,s,c){var u=function(t){e.isDefined(t)?this._localforage=r.createInstance(t):(this._localforage=r,r.config(o))};u.prototype.createInstance=function(r){if(e.isObject(r)){if(r=e.extend({},o,r),e.isDefined(t[r.name]))throw new Error("A localForage instance with the name "+r.name+" is already defined.");return t[r.name]=new u(r),t[r.name]}throw new Error("The parameter should be a config object.")},u.prototype.instance=function(r){if(e.isUndefined(r))return t[o.name];if(e.isString(r)){if(e.isDefined(t[r]))return t[r];throw new Error("No localForage instance of that name exists.")}throw new Error("The parameter should be a string.")},u.prototype.setDriver=function(e){return this._localforage.setDriver(e)},u.prototype.driver=function(){return this._localforage.driver()},u.prototype.setItem=function(r,t){if(e.isUndefined(r))throw new Error("You must define a key to set");var o=this;if(e.isArray(r)){if(!e.isArray(t))throw new Error("If you set an array of keys, the values should be an array too");var i=[];return e.forEach(r,function(e,r){i.push(o.setItem(e,t[r]))}),s.all(i)}var c,u=s.defer(),l=arguments;if(e.isObject(t))if(f(t))c=t;else{for(var d in t)f(t[d])&&(c=t);c||(c=e.copy(t))}else c=e.copy(t);return e.isObject(c)&&e.isDefined(c.$promise)&&delete c.$promise,o._localforage.setItem(o.prefix()+r,c).then(function(){n.setItem&&a.$broadcast("LocalForageModule.setItem",{key:r,newvalue:c,driver:o.driver()}),u.resolve(c)},function(e){o.onError(e,l,o.setItem,u)}),u.promise},u.prototype.getItem=function(r){if(e.isUndefined(r))throw new Error("You must define a key to get");var t,o=s.defer(),n=arguments,i=this;if(e.isArray(r)){var a=[],f=0;t=i._localforage.iterate(function(e,t){var o=r.indexOf(i.prefix()+t);return o>-1&&(a[o]=e,f++),f===r.length?a:void 0})}else t=i._localforage.getItem(i.prefix()+r);return t.then(function(e){o.resolve(e||a)},function(e){i.onError(e,n,i.getItem,o)}),o.promise},u.prototype.iterate=function(r){if(e.isUndefined(r))throw new Error("You must define a callback to iterate");var t=s.defer(),o=arguments,n=this;return n._localforage.iterate(r).then(function(e){t.resolve(e)},function(e){n.onError(e,o,n.iterate,t)}),t.promise},u.prototype.removeItem=function(r){if(e.isUndefined(r))throw new Error("You must define a key to remove");var t=this;if(e.isArray(r)){var o=[];return e.forEach(r,function(e){o.push(t.removeItem(e))}),s.all(o)}var i=s.defer(),f=arguments;return t._localforage.removeItem(t.prefix()+r).then(function(){n.removeItem&&a.$broadcast("LocalForageModule.removeItem",{key:r,driver:t.driver()}),i.resolve()},function(e){t.onError(e,f,t.removeItem,i)}),i.promise},u.prototype.pull=function(r){if(e.isUndefined(r))throw new Error("You must define a key to pull");var t=this,o=s.defer(),n=function(e){o.reject(e)};return t.getItem(r).then(function(e){t.removeItem(r).then(function(){o.resolve(e)},n)},n),o.promise},u.prototype.clear=function(){var e=s.defer(),r=arguments,t=this;return t._localforage.clear().then(function(){e.resolve()},function(o){t.onError(o,r,t.clear,e)}),e.promise},u.prototype.key=function(r){if(e.isUndefined(r))throw new Error("You must define a position to get for the key function");var t=s.defer(),o=arguments,n=this;return n._localforage.key(r).then(function(e){t.resolve(e)},function(e){n.onError(e,o,n.key,t)}),t.promise};var l=function(){var e=s.defer(),r=arguments,t=this;return t._localforage.keys().then(function(r){if(o.oldPrefix&&"localStorageWrapper"===t.driver()){for(var n=[],i=0,a=r.length;a>i;i++)n.push(r[i].substr(t.prefix().length,r[i].length));r=n}e.resolve(r)},function(o){t.onError(o,r,t.keys,e)}),e.promise};return u.prototype.keys=l,u.prototype.getKeys=l,u.prototype.length=function(){var e=s.defer(),r=arguments,t=this;return t._localforage.length().then(function(r){e.resolve(r)},function(o){t.onError(o,r,length,e)}),e.promise},u.prototype.bind=function(r,n){if(e.isString(n))n={key:n};else if(!e.isObject(n)||e.isUndefined(n.key))throw new Error("You must define a key to bind");var a={defaultValue:"",name:o.name};n=e.extend({},a,n);var f=t[n.name];if(e.isUndefined(f))throw new Error("You must use the name of an existing instance");var s=n.scopeKey||n.key,u=c(s);return f.getItem(n.key).then(function(t){return t?u.assign(r,t):n.defaultValue&&(u.assign(r,n.defaultValue),f.setItem(n.key,n.defaultValue)),e.isDefined(i[n.key])&&i[n.key](),i[n.key]=r.$watch(s,function(r){e.isDefined(r)&&f.setItem(n.key,r)},!0),t})},u.prototype.unbind=function(r,n){if(e.isString(n))n={key:n};else if(!e.isObject(n)||e.isUndefined(n.key))throw new Error("You must define a key to unbind");var a={scopeKey:n.key,name:o.name};n=e.extend({},a,n);var f=t[n.name];if(e.isUndefined(f))throw new Error("You must use the name of an existing instance");return c(n.scopeKey).assign(r,null),e.isDefined(i[n.key])&&(i[n.key](),delete i[n.key]),f.removeItem(n.key)},u.prototype.prefix=function(){return"localStorageWrapper"===this.driver()&&o.oldPrefix?this._localforage.config().name+".":""},u.prototype.onError=function(r,t,o,n){if((e.isObject(r)&&r.name?"InvalidStateError"===r.name:e.isString(r)&&"InvalidStateError"===r)&&"asyncStorage"===this.driver()||e.isObject(r)&&r.code&&5===r.code){var i=this;i.setDriver("localStorageWrapper").then(function(){o.apply(i,t).then(function(e){n.resolve(e)},function(e){n.reject(e)})},function(){n.reject(r)})}else n.reject(r)},t[o.name]=new u,t[o.name]}]}),t.directive("localForage",["$localForage",function(r){return{restrict:"A",link:function(t,o,n){var i=t.$eval(n.localForage);e.isObject(i)&&e.isDefined(i.key)?r.bind(t,i):r.bind(t,n.localForage)}}}])});